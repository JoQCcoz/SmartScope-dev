MacroName  Hole

ReportTargetDefocus TD
TD_low = {defocus_min} # low defocus microns
TD_high = {defocus_max}  #high defocus microns
delta = {defocus_step} # defocus step microns

ReportTargetDefocus TD

if $TD > $TD_low OR $TD <= $TD_high
    SetTargetDefocus $TD_low
else
    IncTargetDefocus -$delta
endif




is_negativestain = {NS}

if $drift_crit > 0
    DriftWaitTask $drift_crit A 300 10 -1 T 1
endif


file =  reference/{reference}
if $is_negativestain == 0
    template_file =  reference\holeref.mrc
    ReadOtherFile 0 T $template_file
endif

hole = {Hole}
xpos = {Xpos}
ypos = {Ypos}

AllowFileOverwrite 1 

SetImageShift 0 0
echo Moving to $hole at X: $xpos Y: $ypos
MoveStageTo $xpos $ypos
if $is_negativestain == 0
    V
    CropCenterToSize A 2048 2048
    AlignTo T
endif
V
OpenTextFile Lock W 0 raw/.lock
CloseTextFile Lock
OpenNewFile $hole.mrc
S
CloseFile
RemoveFile raw/.lock

CallFunction Autoloader::WaitForRefilling
CallFunction Autoloader::WaitForPump 

Autofocus

DriftWaitTask $drift_crit A 300 10 -1 T 1 

OpenTextFile Lock W 0 raw/.lock
CloseTextFile Lock
OpenNewFile $hole_hm.mrc
Preview
S
CloseFile
Delay 1
RemoveFile raw/.lock

RemoveFile $file
